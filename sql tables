-- 1) USERS
CREATE TABLE users (
    id            INT AUTO_INCREMENT PRIMARY KEY,
    username      VARCHAR(255) UNIQUE NOT NULL,
    name          VARCHAR(255)      NOT NULL,
    password      VARCHAR(255)      NOT NULL,  -- bcrypt hash
    role          ENUM('homeowner','admin','user') NOT NULL,
    status        ENUM('pending','active','suspended') DEFAULT 'pending',
    is_approved   BOOLEAN        NOT NULL DEFAULT FALSE,
    created_at    TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    -- only homeowner rows may ever have is_approved = TRUE
    CONSTRAINT chk_only_homeowners_can_be_approved 
      CHECK (role = 'homeowner' OR is_approved = FALSE)
);

-- 2) CHARGE POINTS
CREATE TABLE charge_points (
    id            INT AUTO_INCREMENT PRIMARY KEY,
    homeowner_id  INT NOT NULL UNIQUE,
    address       VARCHAR(255) NOT NULL,
    postcode      VARCHAR(50)  NOT NULL,
    latitude      DECIMAL(10,8) NOT NULL,
    longitude     DECIMAL(11,8) NOT NULL,
    price_per_kwh DECIMAL(5,2)  NOT NULL,
    is_available  BOOLEAN       NOT NULL DEFAULT TRUE,
    image_path    VARCHAR(255),
    created_at    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (homeowner_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 3) BOOKINGS
CREATE TABLE bookings (
    id              INT AUTO_INCREMENT PRIMARY KEY,
    user_id         INT NOT NULL,
    charge_point_id INT NOT NULL,
    start_time      DATETIME    NOT NULL,
    end_time        DATETIME    NOT NULL,
    total_cost      DECIMAL(10,2) NOT NULL,
    status          ENUM('pending','approved','declined','cancelled') DEFAULT 'pending',
    created_at      TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id)         REFERENCES users(id)         ON DELETE CASCADE,
    FOREIGN KEY (charge_point_id) REFERENCES charge_points(id) ON DELETE CASCADE
);

-- 4) CONTACT MESSAGES
CREATE TABLE contact_messages (
    id           INT AUTO_INCREMENT PRIMARY KEY,
    booking_id   INT NOT NULL,
    sender_id    INT NOT NULL,
    recipient_id INT NOT NULL,
    message      TEXT    NOT NULL,
    sent_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id)   REFERENCES bookings(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id)    REFERENCES users(id)    ON DELETE CASCADE,
    FOREIGN KEY (recipient_id) REFERENCES users(id)    ON DELETE CASCADE
);

-- 5) REVIEWS
CREATE TABLE reviews (
    review_id   INT AUTO_INCREMENT PRIMARY KEY,
    booking_id  INT NOT NULL,
    rating      INT     NOT NULL CHECK (rating BETWEEN 1 AND 5),
    comment     TEXT,
    created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
);


-- ────────────────────────────────────────────────────────────────────────────
-- 7) SEED DATA using bcrypt

-- Known bcrypt hash for "123456" generated by PHP:
--   password_hash('123456', PASSWORD_BCRYPT)
--   → $2y$12$n9nRfFXEa3OU3UvAzbkcEuEVj2vZS8iQcmM5GgS/YZKyDY93tNjEm

-- a) Homeowner (approved)
INSERT INTO users (username, name, password, role, status, is_approved)
VALUES (
  'lee@lee.com',
  'Lee Griffiths',
  '$2y$12$n9nRfFXEa3OU3UvAzbkcEuEVj2vZS8iQcmM5GgS/YZKyDY93tNjEm',
  'homeowner',
  'active',
  TRUE
);
SET @homeowner_id = LAST_INSERT_ID();

-- b) Regular user
INSERT INTO users (username, name, password, role, status)
VALUES (
  'user@user.com',
  'User Lee Griffiths',
  '$2y$12$n9nRfFXEa3OU3UvAzbkcEuEVj2vZS8iQcmM5GgS/YZKyDY93tNjEm',
  'user',
  'active'
);

-- c) Admin user
INSERT INTO users (username, name, password, role, status)
VALUES (
  'admin@admin.com',
  'User Lee Griffiths',
  '$2y$12$n9nRfFXEa3OU3UvAzbkcEuEVj2vZS8iQcmM5GgS/YZKyDY93tNjEm',
  'admin',
  'active'
);

-- d) One charge point for the homeowner
INSERT INTO charge_points (
  homeowner_id,
  address,
  postcode,
  latitude,
  longitude,
  price_per_kwh
) VALUES (
  @homeowner_id,
  '5 The Crescent, Salford',
  'M5 4WT',
  53.483710,
  -2.270110,
  0.25
);
